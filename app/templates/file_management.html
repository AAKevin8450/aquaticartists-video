{% extends "base.html" %}

{% block title %}File Management - AWS Video & Image Analysis{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="row">
    <div class="col-12">
        <h1 class="mb-4">
            <i class="bi bi-folder2-open"></i> File Management
        </h1>
    </div>
</div>

<!-- Alert Container -->
<div id="alert-container"></div>

<!-- Import Directory -->
<div class="card mb-4">
    <div class="card-header">
        <h5 class="mb-0"><i class="bi bi-folder-plus"></i> Import Directory</h5>
    </div>
    <div class="card-body">
        <div class="row g-3 align-items-end">
            <div class="col-md-6">
                <label for="importDirectoryPath" class="form-label">Directory Path</label>
                <div class="input-group">
                    <input type="text" class="form-control" id="importDirectoryPath"
                           placeholder="E:\\videos">
                    <button class="btn btn-outline-secondary" type="button" id="importBrowseBtn"
                            data-bs-toggle="modal" data-bs-target="#importFolderBrowserModal">
                        <i class="bi bi-folder2-open"></i> Browse
                    </button>
                </div>
                <small class="text-muted">Import files recursively without moving or copying them</small>
            </div>
            <div class="col-md-3">
                <div class="form-check mt-4">
                    <input class="form-check-input" type="checkbox" id="importRecursive" checked>
                    <label class="form-check-label" for="importRecursive">
                        Include subfolders
                    </label>
                </div>
            </div>
            <div class="col-md-3">
                <button class="btn btn-primary w-100" id="importDirectoryBtn">
                    <i class="bi bi-box-arrow-in-down"></i> Import Directory
                </button>
            </div>
        </div>
        <!-- Import Progress -->
        <div id="importProgress" class="mt-3" style="display: none;"></div>
    </div>
</div>

<!-- Search and Filters Card -->
<div class="card mb-4">
    <div class="card-header py-2">
        <h6 class="mb-0"><i class="bi bi-funnel"></i> Search & Filters</h6>
    </div>
    <div class="card-body py-2">
        <div class="row g-1">
            <!-- Row 1 -->
            <!-- Search bar -->
            <div class="col-lg-3 col-md-4 col-sm-6">
                <label for="searchInput" class="form-label mb-0" style="font-size: 0.75rem;">Search</label>
                <div class="input-group input-group-sm">
                    <span class="input-group-text p-1">
                        <i class="bi bi-search"></i>
                    </span>
                    <input type="text" class="form-control form-control-sm" id="searchInput"
                           placeholder="Search...">
                    <button class="btn btn-outline-secondary btn-sm p-1" id="clearSearchBtn">
                        <i class="bi bi-x"></i>
                    </button>
                </div>
            </div>

            <!-- File Type Filter -->
            <div class="col-lg-1 col-md-2 col-sm-3">
                <label for="fileTypeFilter" class="form-label mb-0" style="font-size: 0.75rem;">Type</label>
                <select class="form-select form-select-sm" id="fileTypeFilter">
                    <option value="">All</option>
                    <option value="video">Video</option>
                    <option value="image">Image</option>
                </select>
            </div>

            <!-- Has Proxy Filter -->
            <div class="col-lg-1 col-md-2 col-sm-3">
                <label for="proxyFilter" class="form-label mb-0" style="font-size: 0.75rem;">Proxy</label>
                <select class="form-select form-select-sm" id="proxyFilter">
                    <option value="">All</option>
                    <option value="true">Yes</option>
                    <option value="false">No</option>
                </select>
            </div>

            <!-- Has Transcription Filter -->
            <div class="col-lg-1 col-md-2 col-sm-3">
                <label for="transcriptionFilter" class="form-label mb-0" style="font-size: 0.75rem;">Transcript</label>
                <select class="form-select form-select-sm" id="transcriptionFilter">
                    <option value="">All</option>
                    <option value="true">Yes</option>
                    <option value="false">No</option>
                </select>
            </div>

            <!-- Nova Analysis Filter -->
            <div class="col-lg-1 col-md-2 col-sm-3">
                <label for="novaFilter" class="form-label mb-0" style="font-size: 0.75rem;">Nova</label>
                <select class="form-select form-select-sm" id="novaFilter">
                    <option value="">All</option>
                    <option value="true">Yes</option>
                    <option value="false">No</option>
                </select>
            </div>

            <!-- Rekognition Analysis Filter -->
            <div class="col-lg-1 col-md-2 col-sm-3">
                <label for="rekognitionFilter" class="form-label mb-0" style="font-size: 0.75rem;">Rekog</label>
                <select class="form-select form-select-sm" id="rekognitionFilter">
                    <option value="">All</option>
                    <option value="true">Yes</option>
                    <option value="false">No</option>
                </select>
            </div>

            <!-- Nova Embeddings Filter -->
            <div class="col-lg-1 col-md-2 col-sm-3">
                <label for="embeddingsFilter" class="form-label mb-0" style="font-size: 0.75rem;">Embed</label>
                <select class="form-select form-select-sm" id="embeddingsFilter">
                    <option value="">All</option>
                    <option value="true">Yes</option>
                    <option value="false">No</option>
                </select>
            </div>

            <!-- Upload From -->
            <div class="col-lg-1 col-md-2 col-sm-3">
                <label for="uploadFromDate" class="form-label mb-0" style="font-size: 0.75rem;">Upl From</label>
                <input type="date" class="form-control form-control-sm" id="uploadFromDate">
            </div>

            <!-- Upload To -->
            <div class="col-lg-1 col-md-2 col-sm-3">
                <label for="uploadToDate" class="form-label mb-0" style="font-size: 0.75rem;">Upl To</label>
                <input type="date" class="form-control form-control-sm" id="uploadToDate">
            </div>

            <!-- Created From -->
            <div class="col-lg-1 col-md-2 col-sm-3">
                <label for="createdFromDate" class="form-label mb-0" style="font-size: 0.75rem;">Cre From</label>
                <input type="date" class="form-control form-control-sm" id="createdFromDate">
            </div>

            <!-- Row 2 -->
            <!-- Created To -->
            <div class="col-lg-1 col-md-2 col-sm-3">
                <label for="createdToDate" class="form-label mb-0" style="font-size: 0.75rem;">Cre To</label>
                <input type="date" class="form-control form-control-sm" id="createdToDate">
            </div>

            <!-- Min Size -->
            <div class="col-lg-1 col-md-2 col-sm-3">
                <label for="minSize" class="form-label mb-0" style="font-size: 0.75rem;">Min MB</label>
                <input type="number" class="form-control form-control-sm" id="minSize" placeholder="0" min="0" step="1">
            </div>

            <!-- Max Size -->
            <div class="col-lg-1 col-md-2 col-sm-3">
                <label for="maxSize" class="form-label mb-0" style="font-size: 0.75rem;">Max MB</label>
                <input type="number" class="form-control form-control-sm" id="maxSize" placeholder="∞" min="0" step="1">
            </div>

            <!-- Min Duration -->
            <div class="col-lg-1 col-md-2 col-sm-3">
                <label for="minDuration" class="form-label mb-0" style="font-size: 0.75rem;">Min Sec</label>
                <input type="number" class="form-control form-control-sm" id="minDuration" placeholder="0" min="0" step="1">
            </div>

            <!-- Max Duration -->
            <div class="col-lg-1 col-md-2 col-sm-3">
                <label for="maxDuration" class="form-label mb-0" style="font-size: 0.75rem;">Max Sec</label>
                <input type="number" class="form-control form-control-sm" id="maxDuration" placeholder="∞" min="0" step="1">
            </div>

            <!-- Min Transcript Chars -->
            <div class="col-lg-1 col-md-2 col-sm-3">
                <label for="minTranscriptChars" class="form-label mb-0" style="font-size: 0.75rem;">Min Chars</label>
                <input type="number" class="form-control form-control-sm" id="minTranscriptChars" placeholder="0" min="0" step="1">
            </div>

            <!-- Row 3 -->
            <!-- Directory Path Filter -->
            <div class="col-lg-6 col-md-8 col-sm-12">
                <label for="directoryPathFilter" class="form-label mb-0" style="font-size: 0.75rem;">Directory Path</label>
                <div class="input-group input-group-sm">
                    <input type="text" class="form-control form-control-sm" id="directoryPathFilter" placeholder="Filter by directory...">
                    <button class="btn btn-outline-secondary btn-sm p-1" type="button" id="filterBrowseBtn">
                        <i class="bi bi-folder2-open"></i>
                    </button>
                    <button class="btn btn-outline-secondary btn-sm p-1" id="clearDirectoryBtn">
                        <i class="bi bi-x"></i>
                    </button>
                </div>
            </div>

            <!-- Include Subdirectories Toggle -->
            <div class="col-lg-2 col-md-4 col-sm-6">
                <label class="form-label mb-0" style="font-size: 0.75rem;">&nbsp;</label>
                <div class="form-check mt-1">
                    <input class="form-check-input" type="checkbox" id="includeSubdirectories" checked>
                    <label class="form-check-label" for="includeSubdirectories" style="font-size: 0.75rem;">
                        Include subdirectories
                    </label>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="col-lg-4 col-md-12 d-flex align-items-end">
                <button class="btn btn-primary btn-sm me-1" id="applyFiltersBtn">
                    <i class="bi bi-funnel"></i> Apply
                </button>
                <button class="btn btn-secondary btn-sm" id="resetFiltersBtn">
                    <i class="bi bi-arrow-counterclockwise"></i> Reset
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Batch Actions Section -->
<div class="card mb-4">
    <div class="card-header">
        <h5 class="mb-0"><i class="bi bi-lightning-fill"></i> Batch Actions</h5>
    </div>
    <div class="card-body">
        <p class="text-muted small mb-3">
            Apply actions to all filtered files. Current filter results: <strong id="batchFilesCount">0 files</strong>
        </p>
        <div class="d-flex flex-wrap gap-2">
            <button class="btn btn-primary" id="batchProxyBtn">
                <i class="bi bi-badge-hd"></i> Generate Proxies
            </button>
            <button class="btn btn-outline-primary" id="batchImageProxyBtn">
                <i class="bi bi-image"></i> Image Proxies (Nova)
            </button>
            <button class="btn btn-info" id="batchTranscribeBtn">
                <i class="bi bi-mic"></i> Transcribe
            </button>
            <button class="btn btn-outline-info" id="batchTranscriptSummaryBtn">
                <i class="bi bi-card-text"></i> Transcript Summaries
            </button>
            <button class="btn btn-warning" id="batchNovaBtn">
                <i class="bi bi-stars"></i> Nova Analysis
            </button>
            <button class="btn btn-success" id="batchRekognitionBtn">
                <i class="bi bi-eye"></i> Rekognition Analysis
            </button>
            <button class="btn btn-secondary" id="batchEmbeddingsBtn">
                <i class="bi bi-vector-pen"></i> Generate Embeddings
            </button>
            <button class="btn btn-outline-primary" id="rescanFolderBtn">
                <i class="bi bi-arrow-repeat"></i> Rescan Folder
            </button>
        </div>
    </div>
</div>

<!-- Source Files Section -->
<div class="card mb-4">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0"><i class="bi bi-file-earmark-play"></i> Source Files</h5>
        <span class="badge bg-primary" id="filesTotalBadge">0 files</span>
    </div>
    <div class="card-body">
        <!-- Summary Statistics -->
        <div class="alert alert-info mb-3" id="filesSummary" style="display: none;">
            <div class="row text-center">
                <div class="col-md-3">
                    <div class="d-flex flex-column">
                        <small class="text-muted">Total Files</small>
                        <h5 class="mb-0" id="summaryCount">-</h5>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="d-flex flex-column">
                        <small class="text-muted">Total Size</small>
                        <h5 class="mb-0" id="summarySize">-</h5>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="d-flex flex-column">
                        <small class="text-muted">Total Proxy Size</small>
                        <h5 class="mb-0" id="summaryProxySize">-</h5>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="d-flex flex-column">
                        <small class="text-muted">Total Duration</small>
                        <h5 class="mb-0" id="summaryDuration">-</h5>
                    </div>
                </div>
            </div>
        </div>

        <div id="filesContainer">
            <div class="text-center">
                <div class="spinner-border" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
            </div>
        </div>

        <!-- Pagination -->
        <nav class="mt-3" id="paginationNav" style="display: none;">
            <ul class="pagination justify-content-center mb-0" id="pagination">
                <!-- Generated dynamically -->
            </ul>
        </nav>
    </div>
</div>

<!-- S3 Files Section (Collapsible) -->
<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <button class="btn btn-link text-decoration-none flex-grow-1 text-start p-0"
                data-bs-toggle="collapse" data-bs-target="#s3FilesCollapse">
            <h5 class="mb-0">
                <i class="bi bi-cloud"></i> S3 Files
                <span class="badge bg-secondary ms-2" id="s3FilesCountBadge">0 files</span>
                <i class="bi bi-chevron-down"></i>
            </h5>
        </button>
        <button class="btn btn-sm btn-danger" id="deleteAllS3Btn" title="Delete all S3 files">
            <i class="bi bi-trash"></i> Delete All
        </button>
    </div>
    <div class="collapse" id="s3FilesCollapse">
        <div class="card-body">
            <div id="s3FilesContainer">
                <p class="text-muted">Click to load S3 files...</p>
            </div>
        </div>
    </div>
</div>

<!-- File Details Modal -->
<div class="modal fade" id="fileDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">File Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="fileDetailsBody">
                <div class="text-center">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Transcript Details Modal -->
<div class="modal fade" id="transcriptDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Transcript Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="transcriptDetailsBody">
                <div class="text-center">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-primary dropdown-toggle" data-bs-toggle="dropdown">
                        <i class="bi bi-download"></i> Download
                    </button>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item download-transcript-btn" href="#" data-format="txt">
                            <i class="bi bi-file-text"></i> Plain Text (.txt)
                        </a></li>
                        <li><a class="dropdown-item download-transcript-btn" href="#" data-format="json">
                            <i class="bi bi-file-code"></i> JSON (.json)
                        </a></li>
                        <li><a class="dropdown-item download-transcript-btn" href="#" data-format="srt">
                            <i class="bi bi-badge-cc"></i> SubRip (.srt)
                        </a></li>
                        <li><a class="dropdown-item download-transcript-btn" href="#" data-format="vtt">
                            <i class="bi bi-badge-cc"></i> WebVTT (.vtt)
                        </a></li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Single File Options Modal -->
<div class="modal fade" id="singleOptionsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-sliders"></i> Processing Options
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p class="text-muted small mb-3" id="singleOptionsDescription">Configure processing settings.</p>
                <div class="alert alert-danger d-none" id="singleOptionsError"></div>

                <form id="singleOptionsForm">
                    <div class="single-options-group" data-action="transcribe" style="display: none;">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">Provider</label>
                                <select class="form-select" id="singleTranscribeProvider">
                                    <option value="whisper" selected>Whisper (local)</option>
                                    <option value="nova_sonic">Nova 2 Sonic (Bedrock)</option>
                                </select>
                                <small class="text-muted">Nova Sonic requires S3 access.</small>
                            </div>
                            <div class="col-md-6 single-whisper-settings">
                                <label class="form-label">Whisper Model</label>
                                <select class="form-select" id="singleTranscribeModel">
                                    <option value="tiny">tiny</option>
                                    <option value="base">base</option>
                                    <option value="small">small</option>
                                    <option value="medium" selected>medium</option>
                                    <option value="large-v2">large-v2</option>
                                    <option value="large-v3">large-v3</option>
                                </select>
                            </div>
                            <div class="col-md-6 single-whisper-settings">
                                <label class="form-label">Device</label>
                                <select class="form-select" id="singleTranscribeDevice">
                                    <option value="auto" selected>auto</option>
                                    <option value="cpu">cpu</option>
                                    <option value="cuda">cuda</option>
                                </select>
                            </div>
                            <div class="col-md-6 single-whisper-settings">
                                <label class="form-label">Compute Type</label>
                                <select class="form-select" id="singleTranscribeCompute">
                                    <option value="default" selected>default</option>
                                    <option value="int8">int8</option>
                                    <option value="float16">float16</option>
                                    <option value="float32">float32</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Language (optional)</label>
                                <input type="text" class="form-control" id="singleTranscribeLanguage" placeholder="auto">
                                <small class="text-muted">Use ISO codes like en, es, fr.</small>
                            </div>
                            <div class="col-12">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="singleTranscribeForce">
                                    <label class="form-check-label" for="singleTranscribeForce">
                                        Re-transcribe even if a completed transcript exists
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="single-options-group" data-action="nova" style="display: none;">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">Model</label>
                                <select class="form-select" id="singleNovaModel">
                                    <option value="lite" selected>Nova 2 Lite</option>
                                    <option value="pro">Nova Pro</option>
                                    <option value="premier">Nova Premier</option>
                                </select>
                                <small class="text-muted">Uses Nova model keys (lite, pro, premier).</small>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Processing Mode</label>
                                <select class="form-select" id="singleNovaProcessingMode">
                                    <option value="realtime" selected>Realtime</option>
                                    <option value="batch">Batch (50% off)</option>
                                </select>
                                <small class="text-muted" id="singleNovaProcessingNote">Batch runs via Bedrock batch jobs.</small>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Summary Depth</label>
                                <select class="form-select" id="singleNovaSummaryDepth">
                                    <option value="brief">Brief</option>
                                    <option value="standard">Standard</option>
                                    <option value="detailed" selected>Detailed</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Language</label>
                                <select class="form-select" id="singleNovaLanguage">
                                    <option value="auto">Auto-detect</option>
                                    <option value="en" selected>English</option>
                                    <option value="es">Spanish</option>
                                    <option value="fr">French</option>
                                    <option value="de">German</option>
                                    <option value="ja">Japanese</option>
                                    <option value="zh">Chinese</option>
                                </select>
                            </div>
                            <div class="col-12">
                                <label class="form-label">Analysis Types</label>
                                <div class="row g-2">
                                    <div class="col-md-4">
                                        <div class="form-check">
                                            <input class="form-check-input single-nova-type" type="checkbox" id="singleNovaSummary" value="summary" checked>
                                            <label class="form-check-label" for="singleNovaSummary">Summary</label>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-check">
                                            <input class="form-check-input single-nova-type" type="checkbox" id="singleNovaChapters" value="chapters" checked>
                                            <label class="form-check-label" for="singleNovaChapters">Chapters</label>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-check">
                                            <input class="form-check-input single-nova-type" type="checkbox" id="singleNovaElements" value="elements" checked>
                                            <label class="form-check-label" for="singleNovaElements">Elements</label>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-check">
                                            <input class="form-check-input single-nova-type" type="checkbox" id="singleNovaWaterfall" value="waterfall_classification" checked>
                                            <label class="form-check-label" for="singleNovaWaterfall">Waterfall Classification</label>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-check">
                                            <input class="form-check-input single-nova-type" type="checkbox" id="singleNovaCombined" value="combined">
                                            <label class="form-check-label" for="singleNovaCombined">Combined (single pass)</label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="single-options-group" data-action="rekognition" style="display: none;">
                        <div class="row g-3">
                            <div class="col-12">
                                <label class="form-label">Analysis Types</label>
                                <div class="row g-2">
                                    <div class="col-md-6">
                                        <div class="form-check">
                                            <input class="form-check-input single-rekognition-type" type="checkbox" id="singleRekognitionLabels" value="label_detection" checked>
                                            <label class="form-check-label" for="singleRekognitionLabels">Label Detection</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input single-rekognition-type" type="checkbox" id="singleRekognitionFaces" value="face_detection">
                                            <label class="form-check-label" for="singleRekognitionFaces">Face Detection</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input single-rekognition-type" type="checkbox" id="singleRekognitionCelebrities" value="celebrity_recognition">
                                            <label class="form-check-label" for="singleRekognitionCelebrities">Celebrity Recognition</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input single-rekognition-type" type="checkbox" id="singleRekognitionModeration" value="content_moderation">
                                            <label class="form-check-label" for="singleRekognitionModeration">Content Moderation</label>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-check">
                                            <input class="form-check-input single-rekognition-type" type="checkbox" id="singleRekognitionText" value="text_detection">
                                            <label class="form-check-label" for="singleRekognitionText">Text Detection</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input single-rekognition-type" type="checkbox" id="singleRekognitionPersons" value="person_tracking">
                                            <label class="form-check-label" for="singleRekognitionPersons">Person Tracking</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input single-rekognition-type" type="checkbox" id="singleRekognitionShots" value="shot_segmentation">
                                            <label class="form-check-label" for="singleRekognitionShots">Shot Segmentation</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input single-rekognition-type" type="checkbox" id="singleRekognitionPPE" value="ppe_detection">
                                            <label class="form-check-label" for="singleRekognitionPPE">PPE Detection (images)</label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-12">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="singleRekognitionUseProxy" checked>
                                    <label class="form-check-label" for="singleRekognitionUseProxy">
                                        Use proxy for video analysis when available
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" id="singleOptionsCancelBtn" data-bs-dismiss="modal">
                    Cancel
                </button>
                <button type="button" class="btn btn-primary" id="singleOptionsConfirmBtn">
                    Start
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Batch Options Modal -->
<div class="modal fade" id="batchOptionsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-sliders"></i> Batch Options
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p class="text-muted small mb-3" id="batchOptionsDescription">Configure batch settings.</p>
                <div class="alert alert-danger d-none" id="batchOptionsError"></div>

                <form id="batchOptionsForm">
                    <div class="batch-options-group" data-action="proxy">
                        <div class="border rounded p-3 bg-light">
                            <h6 class="mb-2">Proxy Generation</h6>
                            <p class="mb-0 text-muted small">
                                Proxies are generated at 720p/15fps for eligible videos. No additional options.
                            </p>
                        </div>
                    </div>

                    <div class="batch-options-group" data-action="transcribe" style="display: none;">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">Provider</label>
                                <select class="form-select" id="batchTranscribeProvider">
                                    <option value="whisper" selected>Whisper (local)</option>
                                    <option value="nova_sonic">Nova 2 Sonic (Bedrock)</option>
                                </select>
                                <small class="text-muted">Nova Sonic requires S3 access.</small>
                            </div>
                            <div class="col-md-6 batch-whisper-settings">
                                <label class="form-label">Whisper Model</label>
                                <select class="form-select" id="batchTranscribeModel">
                                    <option value="tiny">tiny</option>
                                    <option value="base">base</option>
                                    <option value="small">small</option>
                                    <option value="medium" selected>medium</option>
                                    <option value="large-v2">large-v2</option>
                                    <option value="large-v3">large-v3</option>
                                </select>
                            </div>
                            <div class="col-md-6 batch-whisper-settings">
                                <label class="form-label">Device</label>
                                <select class="form-select" id="batchTranscribeDevice">
                                    <option value="auto" selected>auto</option>
                                    <option value="cpu">cpu</option>
                                    <option value="cuda">cuda</option>
                                </select>
                            </div>
                            <div class="col-md-6 batch-whisper-settings">
                                <label class="form-label">Compute Type</label>
                                <select class="form-select" id="batchTranscribeCompute">
                                    <option value="default" selected>default</option>
                                    <option value="int8">int8</option>
                                    <option value="float16">float16</option>
                                    <option value="float32">float32</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Language (optional)</label>
                                <input type="text" class="form-control" id="batchTranscribeLanguage" placeholder="auto">
                                <small class="text-muted">Use ISO codes like en, es, fr.</small>
                            </div>
                            <div class="col-12">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="batchTranscribeForce">
                                    <label class="form-check-label" for="batchTranscribeForce">
                                        Re-transcribe even if a completed transcript exists
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="batch-options-group" data-action="transcript-summary" style="display: none;">
                        <div class="border rounded p-3 bg-light">
                            <h6 class="mb-2">Transcript Summary Generation</h6>
                            <p class="mb-3 text-muted small">
                                Uses Nova 2 Lite to generate a concise transcript summary under 1,000 characters.
                                Existing summaries are skipped unless overwritten.
                            </p>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="batchTranscriptSummaryForce">
                                <label class="form-check-label" for="batchTranscriptSummaryForce">
                                    Overwrite existing transcript summaries
                                </label>
                            </div>
                        </div>
                    </div>

                    <div class="batch-options-group" data-action="nova" style="display: none;">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">Model</label>
                                <select class="form-select" id="batchNovaModel">
                                    <option value="lite" selected>Nova 2 Lite</option>
                                    <option value="pro">Nova Pro</option>
                                    <option value="premier">Nova Premier</option>
                                </select>
                                <small class="text-muted">Uses Nova model keys (lite, pro, premier).</small>
                                <label class="form-label mt-3">Processing Mode</label>
                                <select class="form-select" id="batchNovaProcessingMode">
                                    <option value="realtime" selected>Realtime</option>
                                    <option value="batch">Batch (50% off)</option>
                                </select>
                                <small class="text-muted" id="batchNovaProcessingNote">Batch runs via Bedrock batch jobs.</small>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Summary Depth</label>
                                <select class="form-select" id="batchNovaSummaryDepth">
                                    <option value="brief">Brief</option>
                                    <option value="standard">Standard</option>
                                    <option value="detailed" selected>Detailed</option>
                                </select>
                                <label class="form-label mt-3">Language</label>
                                <select class="form-select" id="batchNovaLanguage">
                                    <option value="auto">Auto-detect</option>
                                    <option value="en" selected>English</option>
                                    <option value="es">Spanish</option>
                                    <option value="fr">French</option>
                                    <option value="de">German</option>
                                    <option value="ja">Japanese</option>
                                    <option value="zh">Chinese</option>
                                </select>
                            </div>
                            <div class="col-12">
                                <label class="form-label">Analysis Types</label>
                                <div class="row g-2">
                                    <div class="col-md-4">
                                        <div class="form-check">
                                            <input class="form-check-input batch-nova-type" type="checkbox" id="batchNovaSummary" value="summary">
                                            <label class="form-check-label" for="batchNovaSummary">Summary</label>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-check">
                                            <input class="form-check-input batch-nova-type" type="checkbox" id="batchNovaChapters" value="chapters">
                                            <label class="form-check-label" for="batchNovaChapters">Chapters</label>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-check">
                                            <input class="form-check-input batch-nova-type" type="checkbox" id="batchNovaElements" value="elements">
                                            <label class="form-check-label" for="batchNovaElements">Elements</label>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-check">
                                            <input class="form-check-input batch-nova-type" type="checkbox" id="batchNovaWaterfall" value="waterfall_classification">
                                            <label class="form-check-label" for="batchNovaWaterfall">Waterfall Classification</label>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-check">
                                            <input class="form-check-input batch-nova-type" type="checkbox" id="batchNovaCombined" value="combined" checked>
                                            <label class="form-check-label" for="batchNovaCombined">Combined (single pass)</label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="batch-options-group" data-action="rekognition" style="display: none;">
                        <div class="row g-3">
                            <div class="col-12">
                                <label class="form-label">Analysis Types</label>
                                <div class="row g-2">
                                    <div class="col-md-6">
                                        <div class="form-check">
                                            <input class="form-check-input batch-rekognition-type" type="checkbox" id="batchRekognitionLabels" value="label_detection" checked>
                                            <label class="form-check-label" for="batchRekognitionLabels">Label Detection</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input batch-rekognition-type" type="checkbox" id="batchRekognitionFaces" value="face_detection">
                                            <label class="form-check-label" for="batchRekognitionFaces">Face Detection</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input batch-rekognition-type" type="checkbox" id="batchRekognitionCelebrities" value="celebrity_recognition">
                                            <label class="form-check-label" for="batchRekognitionCelebrities">Celebrity Recognition</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input batch-rekognition-type" type="checkbox" id="batchRekognitionModeration" value="content_moderation">
                                            <label class="form-check-label" for="batchRekognitionModeration">Content Moderation</label>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-check">
                                            <input class="form-check-input batch-rekognition-type" type="checkbox" id="batchRekognitionText" value="text_detection">
                                            <label class="form-check-label" for="batchRekognitionText">Text Detection</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input batch-rekognition-type" type="checkbox" id="batchRekognitionPersons" value="person_tracking">
                                            <label class="form-check-label" for="batchRekognitionPersons">Person Tracking</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input batch-rekognition-type" type="checkbox" id="batchRekognitionShots" value="shot_segmentation">
                                            <label class="form-check-label" for="batchRekognitionShots">Shot Segmentation</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input batch-rekognition-type" type="checkbox" id="batchRekognitionPPE" value="ppe_detection">
                                            <label class="form-check-label" for="batchRekognitionPPE">PPE Detection (images)</label>
                                        </div>
                                    </div>
                                </div>
                                <small class="text-muted d-block mt-2">
                                    Some analysis types only apply to videos or images; incompatible choices may fail.
                                </small>
                            </div>
                            <div class="col-12">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="batchRekognitionUseProxy" checked>
                                    <label class="form-check-label" for="batchRekognitionUseProxy">
                                        Use proxy files when available
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="batch-options-group" data-action="embeddings" style="display: none;">
                        <div class="row g-3">
                            <div class="col-12">
                                <div class="border rounded p-3 bg-light">
                                    <h6 class="mb-2">Embeddings Generation</h6>
                                    <p class="mb-2 text-muted small">
                                        Generate Nova Embeddings for transcripts and Nova analysis results.
                                        This enables AI-powered semantic search across your video content.
                                    </p>
                                    <ul class="mb-0 text-muted small">
                                        <li>Uses AWS Nova Multimodal Embeddings (1024 dimensions)</li>
                                        <li>Automatically chunks long transcripts into 4000-character segments</li>
                                        <li>Skips content that's already been embedded (idempotent)</li>
                                        <li>Only processes files with completed transcripts or Nova analysis</li>
                                    </ul>
                                </div>
                            </div>
                            <div class="col-12">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="batchEmbeddingsForce">
                                    <label class="form-check-label" for="batchEmbeddingsForce">
                                        Force re-embed existing content
                                    </label>
                                    <small class="text-muted d-block">
                                        If checked, re-generates embeddings even if they already exist. Use with caution (incurs API costs).
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" id="batchOptionsCancelBtn" data-bs-dismiss="modal">
                    Cancel
                </button>
                <button type="button" class="btn btn-primary" id="batchOptionsConfirmBtn">
                    Start Batch
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Batch Progress Modal -->
<div class="modal fade" id="batchProgressModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-lightning-fill"></i> Batch Processing
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" id="batchCloseBtn" disabled></button>
            </div>
            <div class="modal-body">
                <!-- Progress Overview -->
                <div class="mb-4">
                    <h6 id="batchActionTitle">Processing...</h6>
                    <div class="progress" style="height: 30px;">
                        <div class="progress-bar progress-bar-striped progress-bar-animated"
                             role="progressbar"
                             id="batchProgressBar"
                             style="width: 0%">
                            <span id="batchProgressText">0%</span>
                        </div>
                    </div>
                    <div class="mt-2 d-flex justify-content-between text-muted small">
                        <span id="batchStatusText">Starting...</span>
                        <span id="batchCountText">0 / 0</span>
                    </div>
                </div>

                <!-- Current File -->
                <div class="alert alert-info mb-3" id="batchCurrentFile" style="display: none;">
                    <small class="text-muted">Current file:</small><br>
                    <strong id="batchCurrentFileName">-</strong>
                </div>

                <!-- Statistics -->
                <div class="row text-center mb-3" id="batchStats" style="display: none;">
                    <div class="col-3">
                        <div class="d-flex flex-column">
                            <small class="text-muted">Total</small>
                            <h5 class="mb-0" id="batchTotal">0</h5>
                        </div>
                    </div>
                    <div class="col-3">
                        <div class="d-flex flex-column">
                            <small class="text-muted">Completed</small>
                            <h5 class="mb-0 text-success" id="batchCompleted">0</h5>
                        </div>
                    </div>
                    <div class="col-3">
                        <div class="d-flex flex-column">
                            <small class="text-muted">Failed</small>
                            <h5 class="mb-0 text-danger" id="batchFailed">0</h5>
                        </div>
                    </div>
                    <div class="col-3">
                        <div class="d-flex flex-column">
                            <small class="text-muted">Elapsed</small>
                            <h5 class="mb-0" id="batchElapsed">0s</h5>
                        </div>
                    </div>
                </div>

                <!-- Detailed Statistics (for transcription and proxy) -->
                <div class="row text-center mb-3" id="batchDetailedStats" style="display: none;">
                    <div class="col-3">
                        <div class="d-flex flex-column">
                            <small class="text-muted" id="batchLabel1" title="Total or average size">Metric 1</small>
                            <h6 class="mb-0" id="batchAvgSizeTotal">-</h6>
                        </div>
                    </div>
                    <div class="col-3">
                        <div class="d-flex flex-column">
                            <small class="text-muted" id="batchLabel2" title="Processed size metric">Metric 2</small>
                            <h6 class="mb-0" id="batchAvgSizeProcessed">-</h6>
                        </div>
                    </div>
                    <div class="col-3">
                        <div class="d-flex flex-column">
                            <small class="text-muted" id="batchLabel3" title="Time or size metric">Metric 3</small>
                            <h6 class="mb-0" id="batchAvgTime">-</h6>
                        </div>
                    </div>
                    <div class="col-3">
                        <div class="d-flex flex-column">
                            <small class="text-muted" id="batchLabel4" title="Estimated time remaining">ETA</small>
                            <h6 class="mb-0" id="batchETA">-</h6>
                        </div>
                    </div>
                </div>

                <!-- Error List (collapsible) -->
                <div id="batchErrorsSection" style="display: none;">
                    <hr>
                    <button class="btn btn-sm btn-outline-danger mb-2"
                            data-bs-toggle="collapse"
                            data-bs-target="#batchErrorsList">
                        <i class="bi bi-exclamation-triangle"></i>
                        View Errors (<span id="batchErrorCount">0</span>)
                    </button>
                    <div class="collapse" id="batchErrorsList">
                        <div class="list-group" id="batchErrorsContainer">
                            <!-- Error items will be added here -->
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-danger" id="batchCancelBtn">
                    <i class="bi bi-x-circle"></i> Cancel
                </button>
                <button type="button" class="btn btn-secondary" id="batchDoneBtn" style="display: none;" data-bs-dismiss="modal">
                    Close
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Folder Browser Modal (for Import) -->
<div class="modal fade" id="importFolderBrowserModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-folder2-open"></i> Select Folder</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label fw-bold">Current Path:</label>
                    <div class="input-group">
                        <input type="text" class="form-control" id="importCurrentBrowsePath" readonly>
                        <button class="btn btn-outline-secondary" type="button" id="importGoToPathBtn">
                            <i class="bi bi-arrow-right"></i> Go
                        </button>
                    </div>
                </div>

                <div class="mb-3" id="importDriveSelector" style="display: none;">
                    <label class="form-label fw-bold">Drives:</label>
                    <div id="importDriveButtons" class="btn-group flex-wrap" role="group">
                        <!-- Populated by JavaScript -->
                    </div>
                </div>

                <div class="mb-3">
                    <button class="btn btn-sm btn-outline-secondary" id="importGoUpBtn" disabled>
                        <i class="bi bi-arrow-up"></i> Parent Folder
                    </button>
                </div>

                <div class="border rounded" style="height: 350px; overflow-y: auto;">
                    <div id="importFolderList" class="list-group list-group-flush">
                        <div class="text-center p-4">
                            <div class="spinner-border" role="status"></div>
                            <p class="mt-2 mb-0">Loading folders...</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="importSelectFolderBtn">
                    <i class="bi bi-check-lg"></i> Select This Folder
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Folder Browser Modal (for Filter) -->
<div class="modal fade" id="filterFolderBrowserModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-folder2-open"></i> Select Folder to Filter</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label fw-bold">Current Path:</label>
                    <div class="input-group">
                        <input type="text" class="form-control" id="filterCurrentBrowsePath" readonly>
                        <button class="btn btn-outline-secondary" type="button" id="filterGoToPathBtn">
                            <i class="bi bi-arrow-right"></i> Go
                        </button>
                    </div>
                </div>

                <div class="mb-3" id="filterDriveSelector" style="display: none;">
                    <label class="form-label fw-bold">Drives:</label>
                    <div id="filterDriveButtons" class="btn-group flex-wrap" role="group">
                        <!-- Populated by JavaScript -->
                    </div>
                </div>

                <div class="mb-3">
                    <button class="btn btn-sm btn-outline-secondary" id="filterGoUpBtn" disabled>
                        <i class="bi bi-arrow-up"></i> Parent Folder
                    </button>
                </div>

                <div class="border rounded" style="height: 350px; overflow-y: auto;">
                    <div id="filterFolderList" class="list-group list-group-flush">
                        <div class="text-center p-4">
                            <div class="spinner-border" role="status"></div>
                            <p class="mt-2 mb-0">Loading folders...</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="filterSelectFolderBtn">
                    <i class="bi bi-check-lg"></i> Select This Folder
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Rescan Folder Modal -->
<div class="modal fade" id="rescanModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-arrow-repeat"></i> Rescan Directory
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- Step 1: Directory Selection -->
                <div id="rescanStep1">
                    <div class="mb-3">
                        <label for="rescanDirectoryInput" class="form-label">Directory Path</label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="rescanDirectoryInput"
                                   placeholder="Select a directory to rescan" readonly>
                            <button class="btn btn-outline-secondary" type="button" id="rescanBrowseBtn">
                                <i class="bi bi-folder2-open"></i> Browse
                            </button>
                        </div>
                    </div>
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="rescanRecursiveCheck" checked>
                        <label class="form-check-label" for="rescanRecursiveCheck">
                            Recursive scan (include subdirectories)
                        </label>
                    </div>
                    <button class="btn btn-primary" id="rescanStartBtn">
                        <i class="bi bi-search"></i> Scan Now
                    </button>
                </div>

                <!-- Step 2: Results Display -->
                <div id="rescanStep2" style="display: none;">
                    <!-- Summary -->
                    <div class="alert alert-info">
                        <h6 class="mb-2">Scan Results Summary</h6>
                        <div class="row">
                            <div class="col-md-3">
                                <small class="text-muted">Files on disk:</small>
                                <strong id="rescanTotalDisk">0</strong>
                            </div>
                            <div class="col-md-3">
                                <small class="text-muted">Files in database:</small>
                                <strong id="rescanTotalDB">0</strong>
                            </div>
                            <div class="col-md-2">
                                <small class="text-muted">Unchanged:</small>
                                <strong id="rescanMatched">0</strong>
                            </div>
                            <div class="col-md-2">
                                <small class="text-muted">Moved:</small>
                                <strong id="rescanMoved" class="text-warning">0</strong>
                            </div>
                            <div class="col-md-2">
                                <small class="text-muted">Deleted:</small>
                                <strong id="rescanDeleted" class="text-danger">0</strong>
                            </div>
                        </div>
                        <div class="row mt-2">
                            <div class="col-md-3">
                                <small class="text-muted">New files:</small>
                                <strong id="rescanNew" class="text-success">0</strong>
                            </div>
                            <div class="col-md-3">
                                <small class="text-muted">Ambiguous:</small>
                                <strong id="rescanAmbiguous" class="text-info">0</strong>
                            </div>
                        </div>
                    </div>

                    <!-- Moved Files -->
                    <div id="rescanMovedSection" style="display: none;">
                        <div class="card mb-3">
                            <div class="card-header bg-warning bg-opacity-10">
                                <h6 class="mb-0">
                                    <i class="bi bi-arrow-right-circle"></i> Moved Files
                                    <span class="badge bg-warning" id="rescanMovedBadge">0</span>
                                </h6>
                            </div>
                            <div class="card-body">
                                <p class="text-muted small">
                                    These files were found at different paths but matched by fingerprint.
                                    Updating their paths will preserve all analysis data.
                                </p>
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="checkbox" id="rescanSelectAllMoved">
                                    <label class="form-check-label" for="rescanSelectAllMoved">
                                        Select all
                                    </label>
                                </div>
                                <div id="rescanMovedList" class="list-group"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Deleted Files -->
                    <div id="rescanDeletedSection" style="display: none;">
                        <div class="card mb-3">
                            <div class="card-header bg-danger bg-opacity-10">
                                <h6 class="mb-0">
                                    <i class="bi bi-trash"></i> Deleted from Disk
                                    <span class="badge bg-danger" id="rescanDeletedBadge">0</span>
                                </h6>
                            </div>
                            <div class="card-body">
                                <p class="text-muted small">
                                    These files are in the database but no longer exist on disk.
                                    <strong class="text-danger">WARNING:</strong> Removing will delete all proxies and analysis data.
                                </p>
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="checkbox" id="rescanSelectAllDeleted">
                                    <label class="form-check-label" for="rescanSelectAllDeleted">
                                        Select all
                                    </label>
                                </div>
                                <div id="rescanDeletedList" class="list-group"></div>
                            </div>
                        </div>
                    </div>

                    <!-- New Files -->
                    <div id="rescanNewSection" style="display: none;">
                        <div class="card mb-3">
                            <div class="card-header bg-success bg-opacity-10">
                                <h6 class="mb-0">
                                    <i class="bi bi-file-plus"></i> New Files
                                    <span class="badge bg-success" id="rescanNewBadge">0</span>
                                </h6>
                            </div>
                            <div class="card-body">
                                <p class="text-muted small">
                                    These files are on disk but not in the database.
                                    Use the "Import Directory" feature to add them.
                                </p>
                                <div id="rescanNewList" class="list-group"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Ambiguous Files -->
                    <div id="rescanAmbiguousSection" style="display: none;">
                        <div class="card mb-3">
                            <div class="card-header bg-info bg-opacity-10">
                                <h6 class="mb-0">
                                    <i class="bi bi-question-circle"></i> Ambiguous Matches
                                    <span class="badge bg-info" id="rescanAmbiguousBadge">0</span>
                                </h6>
                            </div>
                            <div class="card-body">
                                <p class="text-muted small">
                                    These files have multiple possible matches. Review manually.
                                </p>
                                <div id="rescanAmbiguousList" class="list-group"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="d-flex gap-2">
                        <button class="btn btn-primary" id="rescanApplyBtn">
                            <i class="bi bi-check-lg"></i> Apply Selected Changes
                        </button>
                        <button class="btn btn-secondary" id="rescanBackBtn">
                            <i class="bi bi-arrow-left"></i> Back
                        </button>
                    </div>
                </div>

                <!-- Loading Indicator -->
                <div id="rescanLoading" style="display: none;" class="text-center py-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2 text-muted">Scanning directory...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Select Nova Analysis Modal -->
<div class="modal fade" id="selectNovaAnalysisModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-stars"></i> Select Nova Analysis
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p class="text-muted mb-3">
                    This file has multiple Nova analyses. Choose which one to view:
                </p>

                <!-- Loading Indicator -->
                <div id="novaAnalysesLoading" class="text-center py-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2 text-muted">Loading analyses...</p>
                </div>

                <!-- Analyses List -->
                <div id="novaAnalysesList" style="display: none;">
                    <div class="list-group" id="novaAnalysesContainer">
                        <!-- Populated dynamically -->
                    </div>
                </div>

                <!-- Error Message -->
                <div id="novaAnalysesError" class="alert alert-danger" style="display: none;"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_scripts %}
<script type="module" src="{{ url_for('static', filename='js/file_management.js') }}"></script>
{% endblock %}
