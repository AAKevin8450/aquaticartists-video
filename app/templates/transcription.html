{% extends "base.html" %}

{% block title %}Transcriptions - AWS Video & Image Analysis{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-start flex-wrap gap-3 mb-4">
            <div>
                <h1 class="mb-1">
                    <i class="bi bi-mic"></i> Transcriptions
                </h1>
                <p class="text-muted mb-0">Review and download completed transcripts.</p>
            </div>
            <a href="/files?restore=1" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left"></i> Back to File Management
            </a>
        </div>
    </div>
</div>

<!-- Transcripts List -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-list-ul"></i> Transcripts</h5>
            </div>
            <div class="card-body">
                <!-- Search and Filters -->
                <div class="row g-2 mb-3">
                    <div class="col-md-3">
                        <div class="input-group input-group-sm">
                            <span class="input-group-text"><i class="bi bi-search"></i></span>
                            <input type="text" class="form-control" id="searchInput" placeholder="Search transcripts...">
                            <button class="btn btn-outline-secondary" type="button" id="clearSearchBtn" title="Clear search">
                                <i class="bi bi-x"></i>
                            </button>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <select class="form-select form-select-sm" id="statusFilter">
                            <option value="">All Status</option>
                            <option value="PENDING">Pending</option>
                            <option value="IN_PROGRESS">In Progress</option>
                            <option value="COMPLETED">Completed</option>
                            <option value="FAILED">Failed</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <select class="form-select form-select-sm" id="modelFilter">
                            <option value="">All Models</option>
                            <!-- Populated dynamically -->
                        </select>
                    </div>
                    <div class="col-md-2">
                        <select class="form-select form-select-sm" id="languageFilter">
                            <option value="">All Languages</option>
                            <!-- Populated dynamically -->
                        </select>
                    </div>
                    <div class="col-md-2">
                        <select class="form-select form-select-sm" id="sortByFilter">
                            <option value="created_at">Sort by Date</option>
                            <option value="file_name">Sort by Name</option>
                            <option value="file_size">Sort by Size</option>
                            <option value="processing_time">Sort by Time</option>
                            <option value="model_name">Sort by Model</option>
                        </select>
                    </div>
                    <div class="col-md-1">
                        <button class="btn btn-sm btn-outline-secondary w-100" id="sortOrderBtn" title="Toggle sort order">
                            <i class="bi bi-sort-down" id="sortOrderIcon"></i>
                        </button>
                    </div>
                </div>

                <div id="transcriptsList">
                    <div class="text-center">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- View Transcript Modal -->
<div class="modal fade" id="viewTranscriptModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Transcript Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="transcriptModalBody">
                <div class="text-center">
                    <div class="spinner-border" role="status"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-primary dropdown-toggle" data-bs-toggle="dropdown">
                        <i class="bi bi-download"></i> Download
                    </button>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item download-transcript-btn" href="#" data-format="txt">
                            <i class="bi bi-file-text"></i> Plain Text (.txt)
                        </a></li>
                        <li><a class="dropdown-item download-transcript-btn" href="#" data-format="json">
                            <i class="bi bi-file-code"></i> JSON (.json)
                        </a></li>
                        <li><a class="dropdown-item download-transcript-btn" href="#" data-format="srt">
                            <i class="bi bi-badge-cc"></i> SubRip (.srt)
                        </a></li>
                        <li><a class="dropdown-item download-transcript-btn" href="#" data-format="vtt">
                            <i class="bi bi-badge-cc"></i> WebVTT (.vtt)
                        </a></li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script type="module">
    import { showAlert } from '{{ url_for('static', filename='js/utils.js') }}';

    let currentTranscriptId = null;
    let searchDebounceTimer = null;
    let sortOrder = 'desc';

    // Load transcripts with filters
    async function loadTranscripts() {
        const container = document.getElementById('transcriptsList');

        try {
            const params = new URLSearchParams();
            params.append('limit', '100');

            const statusFilter = document.getElementById('statusFilter').value;
            const modelFilter = document.getElementById('modelFilter').value;
            const languageFilter = document.getElementById('languageFilter').value;
            const searchInput = document.getElementById('searchInput').value.trim();
            const sortBy = document.getElementById('sortByFilter').value;

            if (statusFilter) params.append('status', statusFilter);
            if (modelFilter) params.append('model', modelFilter);
            if (languageFilter) params.append('language', languageFilter);
            if (searchInput) params.append('search', searchInput);
            if (sortBy) params.append('sort_by', sortBy);
            params.append('sort_order', sortOrder);

            const response = await fetch(`/transcriptions/api/transcripts?${params.toString()}`);
            if (!response.ok) throw new Error('Failed to load transcripts');

            const data = await response.json();
            displayTranscripts(data.transcripts, data.total_count);

            // Update filter dropdowns with available options
            updateFilterOptions(data.available_models, data.available_languages);

        } catch (error) {
            console.error('Load transcripts error:', error);
            container.innerHTML = '<p class="text-danger">Failed to load transcripts</p>';
        }
    }

    // Update filter dropdown options
    function updateFilterOptions(models, languages) {
        const modelFilter = document.getElementById('modelFilter');
        const languageFilter = document.getElementById('languageFilter');

        // Update models (preserve current selection)
        const currentModel = modelFilter.value;
        modelFilter.innerHTML = '<option value="">All Models</option>' +
            models.map(m => `<option value="${m}" ${m === currentModel ? 'selected' : ''}>${m}</option>`).join('');

        // Update languages (preserve current selection)
        const currentLang = languageFilter.value;
        languageFilter.innerHTML = '<option value="">All Languages</option>' +
            languages.map(l => `<option value="${l}" ${l === currentLang ? 'selected' : ''}>${l.toUpperCase()}</option>`).join('');
    }

    // Display transcripts
    function displayTranscripts(transcripts, totalCount) {
        const container = document.getElementById('transcriptsList');

        if (transcripts.length === 0) {
            container.innerHTML = '<p class="text-muted">No transcripts found. Try adjusting your filters.</p>';
            return;
        }

        const tableBody = transcripts.map(t => `
            <tr>
                <td><code>${t.id}</code></td>
                <td title="${t.file_path}">
                    <strong>${t.file_name || 'N/A'}</strong><br>
                    <small class="text-muted" style="font-size: 0.75rem;">${truncatePath(t.file_path, 50)}</small>
                </td>
                <td><span class="badge bg-primary">${t.model_name}</span></td>
                <td>${t.language ? t.language.toUpperCase() : 'N/A'}</td>
                <td>${formatFileSize(t.file_size)}</td>
                <td>${formatDurationUI(t.duration_seconds)}</td>
                <td>${formatCount(t.character_count)}</td>
                <td>${formatCount(t.word_count)}</td>
                <td>${t.processing_time ? t.processing_time.toFixed(1) + 's' : 'N/A'}</td>
                <td>
                    <span class="badge ${getStatusBadge(t.status)}">${t.status}</span>
                </td>
                <td>${formatDate(t.created_at)}</td>
                <td>
                    ${t.status === 'COMPLETED' ? `
                        <button class="btn btn-sm btn-info view-transcript-btn" data-id="${t.id}">
                            <i class="bi bi-eye"></i>
                        </button>
                    ` : ''}
                    <button class="btn btn-sm btn-danger delete-transcript-btn" data-id="${t.id}">
                        <i class="bi bi-trash"></i>
                    </button>
                </td>
            </tr>
        `).join('');

        container.innerHTML = `
            <div class="mb-2">
                <small class="text-muted">Displaying ${transcripts.length} of ${totalCount} results</small>
            </div>
            <div class="table-responsive">
                <table class="table table-hover table-sm">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>File</th>
                            <th>Model</th>
                            <th>Lang</th>
                            <th>Size</th>
                            <th>Duration</th>
                            <th>Chars</th>
                            <th>Words</th>
                            <th>Time</th>
                            <th>Status</th>
                            <th>Created</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>${tableBody}</tbody>
                </table>
            </div>
        `;

        attachTranscriptEventListeners();
    }

    // Truncate path for display
    function truncatePath(path, maxLength) {
        if (path.length <= maxLength) return path;
        const half = Math.floor(maxLength / 2);
        return path.substring(0, half) + '...' + path.substring(path.length - half);
    }

    // Format date
    function formatDate(isoDate) {
        if (!isoDate) return 'N/A';
        const date = new Date(isoDate);
        return date.toLocaleString('en-US', {
            month: 'short',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });
    }

    // Attach event listeners
    function attachTranscriptEventListeners() {
        document.querySelectorAll('.view-transcript-btn').forEach(btn => {
            btn.addEventListener('click', () => viewTranscript(parseInt(btn.dataset.id, 10)));
        });

        document.querySelectorAll('.delete-transcript-btn').forEach(btn => {
            btn.addEventListener('click', () => deleteTranscript(parseInt(btn.dataset.id, 10)));
        });
    }

    // View transcript
    async function viewTranscript(transcriptId) {
        currentTranscriptId = transcriptId;
        const modal = new bootstrap.Modal(document.getElementById('viewTranscriptModal'));
        const modalBody = document.getElementById('transcriptModalBody');
        modal.show();

        try {
            modalBody.innerHTML = '<div class="text-center"><div class="spinner-border"></div></div>';

            const response = await fetch(`/transcriptions/api/transcript/${transcriptId}`);
            if (!response.ok) throw new Error('Failed to load transcript');

            const transcript = await response.json();

            modalBody.innerHTML = `
                <div class="mb-3">
                    <h6><i class="bi bi-file-earmark-play"></i> ${transcript.file_name}</h6>
                    <p class="text-muted small mb-2">${transcript.file_path}</p>
                    <div class="row">
                        <div class="col-md-3">
                            <strong>Model:</strong> <span class="badge bg-primary">${transcript.model_name}</span>
                        </div>
                        <div class="col-md-3">
                            <strong>Language:</strong> ${transcript.language ? transcript.language.toUpperCase() : 'N/A'}
                        </div>
                        <div class="col-md-3">
                            <strong>File Size:</strong> ${formatFileSize(transcript.file_size)}
                        </div>
                        <div class="col-md-3">
                            <strong>Duration:</strong> ${formatDurationUI(transcript.duration_seconds)}
                        </div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0">Transcript Text</h6>
                    </div>
                    <div class="card-body" style="white-space: pre-wrap; max-height: 400px; overflow-y: auto;">
                        ${transcript.transcript_text || '<span class="text-muted">No transcript text available.</span>'}
                    </div>
                </div>
            `;

        } catch (error) {
            console.error('View error:', error);
            modalBody.innerHTML = '<p class="text-danger">Failed to load transcript</p>';
        }
    }

    // Delete transcript
    async function deleteTranscript(transcriptId) {
        if (!confirm('Delete this transcript?')) return;

        try {
            const response = await fetch(`/transcriptions/api/transcript/${transcriptId}`, {
                method: 'DELETE'
            });

            if (!response.ok) throw new Error('Failed to delete');

            showAlert('Transcript deleted', 'success');
            loadTranscripts();

        } catch (error) {
            console.error('Delete error:', error);
            showAlert('Failed to delete transcript', 'danger');
        }
    }

    // Download transcript
    document.querySelectorAll('.download-transcript-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
            e.preventDefault();
            if (!currentTranscriptId) return;

            const format = btn.dataset.format;
            const link = document.createElement('a');
            link.href = `/transcriptions/api/transcript/${currentTranscriptId}/download?format=${format}`;
            link.download = `transcript_${currentTranscriptId}.${format}`;
            link.click();
        });
    });

    // Search with debounce
    document.getElementById('searchInput').addEventListener('input', () => {
        if (searchDebounceTimer) clearTimeout(searchDebounceTimer);
        searchDebounceTimer = setTimeout(loadTranscripts, 300);
    });

    // Clear search
    document.getElementById('clearSearchBtn').addEventListener('click', () => {
        document.getElementById('searchInput').value = '';
        loadTranscripts();
    });

    // Filter changes
    document.getElementById('statusFilter').addEventListener('change', loadTranscripts);
    document.getElementById('modelFilter').addEventListener('change', loadTranscripts);
    document.getElementById('languageFilter').addEventListener('change', loadTranscripts);
    document.getElementById('sortByFilter').addEventListener('change', loadTranscripts);

    // Sort order toggle
    document.getElementById('sortOrderBtn').addEventListener('click', () => {
        sortOrder = sortOrder === 'desc' ? 'asc' : 'desc';
        const icon = document.getElementById('sortOrderIcon');
        icon.className = sortOrder === 'desc' ? 'bi bi-sort-down' : 'bi bi-sort-up';
        loadTranscripts();
    });

    const urlParams = new URLSearchParams(window.location.search);
    const preselectTranscriptId = urlParams.get('transcript_id');
    if (preselectTranscriptId) {
        viewTranscript(parseInt(preselectTranscriptId, 10));
    }

    // Helper functions
    function formatFileSize(bytes) {
        if (bytes === 0 || !bytes) return '0 B';
        const k = 1024;
        const sizes = ['B', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return Math.round((bytes / Math.pow(k, i)) * 100) / 100 + ' ' + sizes[i];
    }

    function formatCount(count) {
        if (count === null || count === undefined || count === 0) {
            return 'N/A';
        }
        return count.toLocaleString();
    }

    function formatDurationUI(seconds) {
        if (seconds === null || seconds === undefined || seconds === 0) {
            return 'N/A';
        }

        const hours = Math.floor(seconds / 3600);
        const minutes = Math.floor((seconds % 3600) / 60);
        const secs = Math.floor(seconds % 60);

        if (hours > 0) {
            return `${hours}h ${minutes}m ${secs}s`;
        } else if (minutes > 0) {
            return `${minutes}m ${secs}s`;
        } else {
            return `${secs}s`;
        }
    }

    function getStatusBadge(status) {
        const badges = {
            'PENDING': 'bg-secondary',
            'IN_PROGRESS': 'bg-warning',
            'COMPLETED': 'bg-success',
            'FAILED': 'bg-danger'
        };
        return badges[status] || 'bg-secondary';
    }

    // Load transcripts on page load
    loadTranscripts();
</script>
{% endblock %}
