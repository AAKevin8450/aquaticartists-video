{% extends "base.html" %}

{% block title %}Image Analysis - AWS Video & Image Analysis{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="mb-4">
            <i class="bi bi-image"></i> Image Analysis
        </h1>
    </div>
</div>

{% if error %}
<div class="alert alert-danger" role="alert">
    <i class="bi bi-exclamation-triangle"></i> Error: {{ error }}
</div>
{% endif %}

<div class="row">
    <div class="col-lg-8">
        <!-- Image File Selection -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">Select Image File</h5>
            </div>
            <div class="card-body">
                {% if files %}
                <select class="form-select" id="imageFileSelect">
                    <option value="">-- Select an image file --</option>
                    {% for file in files %}
                    <option value="{{ file.id }}">{{ file.filename }} ({{ file.uploaded_at }})</option>
                    {% endfor %}
                </select>
                {% else %}
                <p class="text-muted">No image files uploaded yet.</p>
                <a href="/upload" class="btn btn-primary">
                    <i class="bi bi-cloud-upload"></i> Upload Image
                </a>
                {% endif %}
            </div>
        </div>

        <!-- Analysis Type Selection -->
        <div class="card mb-4" id="analysisTypeCard" style="display: none;">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Select Analysis Types</h5>
                <div>
                    <button type="button" class="btn btn-sm btn-outline-primary me-2" id="selectAllBtn">Select All</button>
                    <button type="button" class="btn btn-sm btn-outline-secondary" id="deselectAllBtn">Deselect All</button>
                </div>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-6">
                        <div class="form-check">
                            <input class="form-check-input analysis-type-checkbox" type="checkbox" name="analysisType" id="labelDetection" value="label_detection">
                            <label class="form-check-label" for="labelDetection">
                                <strong>Label Detection</strong><br>
                                <small class="text-muted">Identify objects and scenes</small>
                            </label>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-check">
                            <input class="form-check-input analysis-type-checkbox" type="checkbox" name="analysisType" id="faceDetection" value="face_detection">
                            <label class="form-check-label" for="faceDetection">
                                <strong>Face Detection</strong><br>
                                <small class="text-muted">Detect faces and attributes</small>
                            </label>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-check">
                            <input class="form-check-input analysis-type-checkbox" type="checkbox" name="analysisType" id="celebrityRecognition" value="celebrity_recognition">
                            <label class="form-check-label" for="celebrityRecognition">
                                <strong>Celebrity Recognition</strong><br>
                                <small class="text-muted">Identify celebrities</small>
                            </label>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-check">
                            <input class="form-check-input analysis-type-checkbox" type="checkbox" name="analysisType" id="contentModeration" value="content_moderation">
                            <label class="form-check-label" for="contentModeration">
                                <strong>Content Moderation</strong><br>
                                <small class="text-muted">Detect inappropriate content</small>
                            </label>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-check">
                            <input class="form-check-input analysis-type-checkbox" type="checkbox" name="analysisType" id="textDetection" value="text_detection">
                            <label class="form-check-label" for="textDetection">
                                <strong>Text Detection</strong><br>
                                <small class="text-muted">Detect and extract text</small>
                            </label>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-check">
                            <input class="form-check-input analysis-type-checkbox" type="checkbox" name="analysisType" id="ppeDetection" value="ppe_detection">
                            <label class="form-check-label" for="ppeDetection">
                                <strong>PPE Detection</strong><br>
                                <small class="text-muted">Detect protective equipment</small>
                            </label>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-check">
                            <input class="form-check-input analysis-type-checkbox" type="checkbox" name="analysisType" id="faceSearch" value="face_search">
                            <label class="form-check-label" for="faceSearch">
                                <strong>Face Search</strong><br>
                                <small class="text-muted">Search faces in collection</small>
                            </label>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-check">
                            <input class="form-check-input analysis-type-checkbox" type="checkbox" name="analysisType" id="faceComparison" value="face_comparison">
                            <label class="form-check-label" for="faceComparison">
                                <strong>Face Comparison</strong><br>
                                <small class="text-muted">Compare with another image</small>
                            </label>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Collection Selection (for face search) -->
        <div class="card mb-4" id="collectionCard" style="display: none;">
            <div class="card-header">
                <h5 class="mb-0">Select Face Collection</h5>
            </div>
            <div class="card-body">
                <select class="form-select" id="collectionSelect">
                    <option value="">-- Select a collection --</option>
                </select>
            </div>
        </div>

        <!-- Target Image Selection (for face comparison) -->
        <div class="card mb-4" id="targetImageCard" style="display: none;">
            <div class="card-header">
                <h5 class="mb-0">Select Target Image for Comparison</h5>
            </div>
            <div class="card-body">
                <select class="form-select" id="targetImageSelect">
                    <option value="">-- Select target image --</option>
                    {% if files %}
                    {% for file in files %}
                    <option value="{{ file.id }}">{{ file.filename }}</option>
                    {% endfor %}
                    {% endif %}
                </select>
            </div>
        </div>

        <!-- Start Analysis Button -->
        <div class="d-grid gap-2" id="startAnalysisBtn" style="display: none;">
            <button type="button" class="btn btn-success btn-lg" id="analyzeBtn">
                <i class="bi bi-play-circle"></i> Analyze Image
            </button>
        </div>

        <!-- Results Display -->
        <div class="card mt-4" id="resultsCard" style="display: none;">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0">
                    <i class="bi bi-check-circle"></i> Analysis Results
                </h5>
            </div>
            <div class="card-body">
                <div id="resultsContent"></div>
            </div>
        </div>
    </div>

    <div class="col-lg-4">
        <!-- Info Card -->
        <div class="card">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0">
                    <i class="bi bi-info-circle"></i> Information
                </h5>
            </div>
            <div class="card-body">
                <h6>Image Analysis Types:</h6>
                <ul class="small">
                    <li><strong>Label Detection:</strong> Objects, scenes, activities</li>
                    <li><strong>Face Detection:</strong> Faces and facial attributes</li>
                    <li><strong>Celebrity Recognition:</strong> Identify famous people</li>
                    <li><strong>Content Moderation:</strong> Inappropriate content</li>
                    <li><strong>Text Detection:</strong> Extract text from images</li>
                    <li><strong>PPE Detection:</strong> Safety equipment detection</li>
                    <li><strong>Face Search:</strong> Match with collection</li>
                    <li><strong>Face Comparison:</strong> Compare two images</li>
                </ul>
                <hr>
                <p class="small">
                    <strong>Multi-Select:</strong> You can now select multiple analysis types to run simultaneously! All results are displayed together.
                </p>
                <p class="small text-muted">
                    Image analysis is performed synchronously and results are displayed immediately.
                </p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script type="module">
    import { showAlert } from '{{ url_for('static', filename='js/utils.js') }}';

    const imageFileSelect = document.getElementById('imageFileSelect');
    const analysisTypeCard = document.getElementById('analysisTypeCard');
    const collectionCard = document.getElementById('collectionCard');
    const targetImageCard = document.getElementById('targetImageCard');
    const startAnalysisBtn = document.getElementById('startAnalysisBtn');
    const analyzeBtn = document.getElementById('analyzeBtn');
    const collectionSelect = document.getElementById('collectionSelect');
    const targetImageSelect = document.getElementById('targetImageSelect');
    const resultsCard = document.getElementById('resultsCard');
    const resultsContent = document.getElementById('resultsContent');

    // Show analysis type card when image is selected
    if (imageFileSelect) {
        imageFileSelect.addEventListener('change', () => {
            if (imageFileSelect.value) {
                analysisTypeCard.style.display = 'block';
                startAnalysisBtn.style.display = 'block';
                resultsCard.style.display = 'none';
            } else {
                analysisTypeCard.style.display = 'none';
                collectionCard.style.display = 'none';
                targetImageCard.style.display = 'none';
                startAnalysisBtn.style.display = 'none';
                resultsCard.style.display = 'none';
            }
        });
    }

    // Select All / Deselect All buttons
    const selectAllBtn = document.getElementById('selectAllBtn');
    const deselectAllBtn = document.getElementById('deselectAllBtn');

    if (selectAllBtn) {
        selectAllBtn.addEventListener('click', () => {
            document.querySelectorAll('.analysis-type-checkbox').forEach(cb => cb.checked = true);
            updateConditionalCards();
        });
    }

    if (deselectAllBtn) {
        deselectAllBtn.addEventListener('click', () => {
            document.querySelectorAll('.analysis-type-checkbox').forEach(cb => cb.checked = false);
            updateConditionalCards();
        });
    }

    // Show collection/target image card based on selected analysis types
    function updateConditionalCards() {
        const faceSearchChecked = document.getElementById('faceSearch').checked;
        const faceComparisonChecked = document.getElementById('faceComparison').checked;

        resultsCard.style.display = 'none';

        if (faceSearchChecked) {
            loadCollections();
            collectionCard.style.display = 'block';
        } else {
            collectionCard.style.display = 'none';
        }

        if (faceComparisonChecked) {
            targetImageCard.style.display = 'block';
        } else {
            targetImageCard.style.display = 'none';
        }
    }

    document.querySelectorAll('input[name="analysisType"]').forEach(checkbox => {
        checkbox.addEventListener('change', updateConditionalCards);
    });

    // Load face collections
    async function loadCollections() {
        try {
            const response = await fetch('/api/collections');
            if (!response.ok) throw new Error('Failed to load collections');

            const collections = await response.json();
            collectionSelect.innerHTML = '<option value="">-- Select a collection --</option>';
            collections.forEach(col => {
                collectionSelect.innerHTML += `<option value="${col.collection_id}">${col.collection_id}</option>`;
            });
        } catch (error) {
            console.error('Failed to load collections:', error);
            showAlert('Failed to load face collections', 'warning');
        }
    }

    // Start analysis
    if (analyzeBtn) {
        analyzeBtn.addEventListener('click', async () => {
            const fileId = imageFileSelect.value;

            // Collect all checked analysis types
            const analysisTypes = Array.from(document.querySelectorAll('input[name="analysisType"]:checked'))
                .map(cb => cb.value);

            if (!fileId) {
                showAlert('Please select an image file', 'warning');
                return;
            }

            if (analysisTypes.length === 0) {
                showAlert('Please select at least one analysis type', 'warning');
                return;
            }

            const payload = {
                file_id: parseInt(fileId),
                analysis_types: analysisTypes
            };

            // Add collection ID for face search if selected
            if (analysisTypes.includes('face_search')) {
                const collectionId = collectionSelect.value;
                if (!collectionId) {
                    showAlert('Please select a face collection for Face Search', 'warning');
                    return;
                }
                payload.collection_id = collectionId;
            }

            // Add target image for face comparison if selected
            if (analysisTypes.includes('face_comparison')) {
                const targetImageId = targetImageSelect.value;
                if (!targetImageId) {
                    showAlert('Please select a target image for Face Comparison', 'warning');
                    return;
                }
                payload.target_file_id = parseInt(targetImageId);
            }

            try {
                analyzeBtn.disabled = true;
                analyzeBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Analyzing...';
                resultsCard.style.display = 'none';

                const response = await fetch('/api/analysis/image/analyze', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to analyze image');
                }

                const result = await response.json();
                displayResults(result);
                const analysisCount = result.results ? Object.keys(result.results).length : 0;
                showAlert(`Analysis completed successfully! ${analysisCount} analysis type(s) completed.`, 'success');

            } catch (error) {
                console.error('Analysis error:', error);
                showAlert(`Failed to analyze image: ${error.message}`, 'danger');
            } finally {
                analyzeBtn.disabled = false;
                analyzeBtn.innerHTML = '<i class="bi bi-play-circle"></i> Analyze Image';
            }
        });
    }

    function displayResults(result) {
        resultsCard.style.display = 'block';

        // If multiple analysis types, organize results by type
        if (result.results && typeof result.results === 'object') {
            let html = '';
            for (const [analysisType, analysisResult] of Object.entries(result.results)) {
                html += `<div class="mb-4">`;
                html += `<h6 class="text-primary">${formatAnalysisType(analysisType)}</h6>`;
                html += `<pre class="bg-light p-3 rounded">${JSON.stringify(analysisResult, null, 2)}</pre>`;
                html += `</div>`;
            }
            resultsContent.innerHTML = html;
        } else {
            resultsContent.innerHTML = `<pre class="bg-light p-3 rounded">${JSON.stringify(result, null, 2)}</pre>`;
        }

        resultsCard.scrollIntoView({ behavior: 'smooth' });
    }

    function formatAnalysisType(type) {
        const formatted = type.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
        return formatted;
    }
</script>
{% endblock %}
